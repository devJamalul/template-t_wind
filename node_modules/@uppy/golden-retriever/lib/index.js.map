{"version":3,"sources":["index.js"],"names":["throttle","BasePlugin","ServiceWorkerStore","IndexedDBStore","MetaDataStore","packageJson","GoldenRetriever","constructor","uppy","opts","addBlobToStores","file","isRemote","put","catch","err","log","removeBlobFromStores","delete","id","replaceBlobInStores","handleRestoreConfirmed","currentUploads","getState","Object","keys","forEach","uploadId","restore","resumeAll","upload","setState","recoveredState","abortRestore","fileIDs","files","deleteBlobs","then","length","cancelAll","cleanup","handleComplete","successful","map","restoreBlobs","getFiles","Promise","all","loadFileBlobsFromServiceWorker","loadFileBlobsFromIndexedDB","resultingArrayOfObjects","blobs","onBlobsLoaded","type","title","defaultOptions","expires","serviceWorker","storeName","getID","indexedDB","saveFilesStateToLocalStorage","bind","leading","trailing","restoreState","savedState","load","savedPluginData","pluginData","getWaitingFiles","waitingFiles","progress","uploadStarted","getUploadingFiles","uploadingFiles","uploadIDs","uploadID","filesInUpload","fileID","getFile","filesToSave","filesToSaveWithoutData","isRestored","data","preview","emit","assign","save","resolve","list","localFilesOnly","filter","numberOfFilesRecovered","numberOfFilesTryingToRecover","obsoleteBlobs","updatedFiles","originalFile","push","cachedData","updatedFileData","isGhost","promises","install","on","uninstall","off","VERSION","version"],"mappings":";;MAAOA,Q;;MACAC,U;;MACAC,kB;;MACAC,c;;MACAC,a;;MAEAC,W;;;AAEP;AACA;AACA;AACA;AACA;AACA;AACA;;AACe,MAAMC,eAAN,SAA8BL,UAA9B,CAAyC;AAGtDM,EAAAA,WAAW,CAAEC,IAAF,EAAQC,IAAR,EAAc;AACvB,UAAMD,IAAN,EAAYC,IAAZ;;AADuB,SAsPzBC,eAtPyB,GAsPNC,IAAD,IAAU;AAC1B,UAAIA,IAAI,CAACC,QAAT,EAAmB;;AAEnB,UAAI,KAAKV,kBAAT,EAA6B;AAC3B,aAAKA,kBAAL,CAAwBW,GAAxB,CAA4BF,IAA5B,EAAkCG,KAAlC,CAAyCC,GAAD,IAAS;AAC/C,eAAKP,IAAL,CAAUQ,GAAV,CAAc,wCAAd,EAAwD,SAAxD;AACA,eAAKR,IAAL,CAAUQ,GAAV,CAAcD,GAAd;AACD,SAHD;AAID;;AAED,WAAKZ,cAAL,CAAoBU,GAApB,CAAwBF,IAAxB,EAA8BG,KAA9B,CAAqCC,GAAD,IAAS;AAC3C,aAAKP,IAAL,CAAUQ,GAAV,CAAc,wCAAd,EAAwD,SAAxD;AACA,aAAKR,IAAL,CAAUQ,GAAV,CAAcD,GAAd;AACD,OAHD;AAID,KApQwB;;AAAA,SAsQzBE,oBAtQyB,GAsQDN,IAAD,IAAU;AAC/B,UAAI,KAAKT,kBAAT,EAA6B;AAC3B,aAAKA,kBAAL,CAAwBgB,MAAxB,CAA+BP,IAAI,CAACQ,EAApC,EAAwCL,KAAxC,CAA+CC,GAAD,IAAS;AACrD,eAAKP,IAAL,CAAUQ,GAAV,CAAc,yCAAd,EAAyD,SAAzD;AACA,eAAKR,IAAL,CAAUQ,GAAV,CAAcD,GAAd;AACD,SAHD;AAID;;AACD,WAAKZ,cAAL,CAAoBe,MAApB,CAA2BP,IAAI,CAACQ,EAAhC,EAAoCL,KAApC,CAA2CC,GAAD,IAAS;AACjD,aAAKP,IAAL,CAAUQ,GAAV,CAAc,yCAAd,EAAyD,SAAzD;AACA,aAAKR,IAAL,CAAUQ,GAAV,CAAcD,GAAd;AACD,OAHD;AAID,KAjRwB;;AAAA,SAmRzBK,mBAnRyB,GAmRFT,IAAD,IAAU;AAC9B,WAAKM,oBAAL,CAA0BN,IAA1B;AACA,WAAKD,eAAL,CAAqBC,IAArB;AACD,KAtRwB;;AAAA,SAwRzBU,sBAxRyB,GAwRA,MAAM;AAC7B,WAAKb,IAAL,CAAUQ,GAAV,CAAc,oDAAd,EAD6B,CAE7B;;AACA,YAAM;AAAEM,QAAAA;AAAF,UAAqB,KAAKd,IAAL,CAAUe,QAAV,EAA3B;;AACA,UAAID,cAAJ,EAAoB;AAClBE,QAAAA,MAAM,CAACC,IAAP,CAAYH,cAAZ,EAA4BI,OAA5B,CAAqCC,QAAD,IAAc;AAChD,eAAKnB,IAAL,CAAUoB,OAAV,CAAkBD,QAAlB,EAA4BL,cAAc,CAACK,QAAD,CAA1C;AACD,SAFD;AAGA,aAAKnB,IAAL,CAAUqB,SAAV;AACD;;AACD,WAAKrB,IAAL,CAAUsB,MAAV;AACA,WAAKtB,IAAL,CAAUuB,QAAV,CAAmB;AAAEC,QAAAA,cAAc,EAAE;AAAlB,OAAnB;AACD,KApSwB;;AAAA,SAsSzBC,YAtSyB,GAsSV,MAAM;AACnB,WAAKzB,IAAL,CAAUQ,GAAV,CAAc,uCAAd;AAEA,YAAMkB,OAAO,GAAGV,MAAM,CAACC,IAAP,CAAY,KAAKjB,IAAL,CAAUe,QAAV,GAAqBY,KAAjC,CAAhB;AACA,WAAKC,WAAL,CAAiBF,OAAjB,EAA0BG,IAA1B,CAA+B,MAAM;AACnC,aAAK7B,IAAL,CAAUQ,GAAV,CAAe,6BAA4BkB,OAAO,CAACI,MAAO,QAA1D;AACD,OAFD,EAEGxB,KAFH,CAEUC,GAAD,IAAS;AAChB,aAAKP,IAAL,CAAUQ,GAAV,CAAe,sCAAqCkB,OAAO,CAACI,MAAO,QAAnE,EAA4E,SAA5E;AACA,aAAK9B,IAAL,CAAUQ,GAAV,CAAcD,GAAd;AACD,OALD;AAOA,WAAKP,IAAL,CAAU+B,SAAV;AACA,WAAK/B,IAAL,CAAUuB,QAAV,CAAmB;AAAEC,QAAAA,cAAc,EAAE;AAAlB,OAAnB;AACA5B,MAAAA,aAAa,CAACoC,OAAd,CAAsB,KAAKhC,IAAL,CAAUC,IAAV,CAAeU,EAArC;AACD,KApTwB;;AAAA,SAsTzBsB,cAtTyB,GAsTR,QAAoB;AAAA,UAAnB;AAAEC,QAAAA;AAAF,OAAmB;AACnC,YAAMR,OAAO,GAAGQ,UAAU,CAACC,GAAX,CAAgBhC,IAAD,IAAUA,IAAI,CAACQ,EAA9B,CAAhB;AACA,WAAKiB,WAAL,CAAiBF,OAAjB,EAA0BG,IAA1B,CAA+B,MAAM;AACnC,aAAK7B,IAAL,CAAUQ,GAAV,CAAe,6BAA4B0B,UAAU,CAACJ,MAAO,gCAA7D;AACD,OAFD,EAEGxB,KAFH,CAEUC,GAAD,IAAS;AAChB,aAAKP,IAAL,CAAUQ,GAAV,CAAe,sCAAqC0B,UAAU,CAACJ,MAAO,gCAAtE,EAAuG,SAAvG;AACA,aAAK9B,IAAL,CAAUQ,GAAV,CAAcD,GAAd;AACD,OALD;AAOA,WAAKP,IAAL,CAAUuB,QAAV,CAAmB;AAAEC,QAAAA,cAAc,EAAE;AAAlB,OAAnB;AACA5B,MAAAA,aAAa,CAACoC,OAAd,CAAsB,KAAKhC,IAAL,CAAUC,IAAV,CAAeU,EAArC;AACD,KAjUwB;;AAAA,SAmUzByB,YAnUyB,GAmUV,MAAM;AACnB,UAAI,KAAKpC,IAAL,CAAUqC,QAAV,GAAqBP,MAArB,GAA8B,CAAlC,EAAqC;AACnCQ,QAAAA,OAAO,CAACC,GAAR,CAAY,CACV,KAAKC,8BAAL,EADU,EAEV,KAAKC,0BAAL,EAFU,CAAZ,EAGGZ,IAHH,CAGSa,uBAAD,IAA6B;AACnC,gBAAMC,KAAK,GAAG,EAAE,GAAGD,uBAAuB,CAAC,CAAD,CAA5B;AAAiC,eAAGA,uBAAuB,CAAC,CAAD;AAA3D,WAAd;AACA,eAAKE,aAAL,CAAmBD,KAAnB;AACD,SAND;AAOD,OARD,MAQO;AACL,aAAK3C,IAAL,CAAUQ,GAAV,CAAc,kFAAd;AACA,aAAKoC,aAAL,CAAmB,EAAnB;AACD;AACF,KAhVwB;;AAEvB,SAAKC,IAAL,GAAY,UAAZ;AACA,SAAKlC,EAAL,GAAU,KAAKV,IAAL,CAAUU,EAAV,IAAgB,iBAA1B;AACA,SAAKmC,KAAL,GAAa,kBAAb;AAEA,UAAMC,cAAc,GAAG;AACrBC,MAAAA,OAAO,EAAE,KAAK,EAAL,GAAU,EAAV,GAAe,IADH;AACS;AAC9BC,MAAAA,aAAa,EAAE;AAFM,KAAvB;AAKA,SAAKhD,IAAL,GAAY,EAAE,GAAG8C,cAAL;AAAqB,SAAG9C;AAAxB,KAAZ;AAEA,SAAKL,aAAL,GAAqB,IAAIA,aAAJ,CAAkB;AACrCoD,MAAAA,OAAO,EAAE,KAAK/C,IAAL,CAAU+C,OADkB;AAErCE,MAAAA,SAAS,EAAElD,IAAI,CAACmD,KAAL;AAF0B,KAAlB,CAArB;AAIA,SAAKzD,kBAAL,GAA0B,IAA1B;;AACA,QAAI,KAAKO,IAAL,CAAUgD,aAAd,EAA6B;AAC3B,WAAKvD,kBAAL,GAA0B,IAAIA,kBAAJ,CAAuB;AAAEwD,QAAAA,SAAS,EAAElD,IAAI,CAACmD,KAAL;AAAb,OAAvB,CAA1B;AACD;;AACD,SAAKxD,cAAL,GAAsB,IAAIA,cAAJ,CAAmB;AACvCqD,MAAAA,OAAO,EAAE,KAAK/C,IAAL,CAAU+C,OADoB;AAEvC,UAAG,KAAK/C,IAAL,CAAUmD,SAAV,IAAuB,EAA1B,CAFuC;AAGvCF,MAAAA,SAAS,EAAElD,IAAI,CAACmD,KAAL;AAH4B,KAAnB,CAAtB;AAMA,SAAKE,4BAAL,GAAoC7D,QAAQ,CAC1C,KAAK6D,4BAAL,CAAkCC,IAAlC,CAAuC,IAAvC,CAD0C,EAE1C,GAF0C,EAG1C;AAAEC,MAAAA,OAAO,EAAE,IAAX;AAAiBC,MAAAA,QAAQ,EAAE;AAA3B,KAH0C,CAA5C;AAKA,SAAKC,YAAL,GAAoB,KAAKA,YAAL,CAAkBH,IAAlB,CAAuB,IAAvB,CAApB;AACA,SAAKd,8BAAL,GAAsC,KAAKA,8BAAL,CAAoCc,IAApC,CAAyC,IAAzC,CAAtC;AACA,SAAKb,0BAAL,GAAkC,KAAKA,0BAAL,CAAgCa,IAAhC,CAAqC,IAArC,CAAlC;AACA,SAAKV,aAAL,GAAqB,KAAKA,aAAL,CAAmBU,IAAnB,CAAwB,IAAxB,CAArB;AACD;;AAEDG,EAAAA,YAAY,GAAI;AACd,UAAMC,UAAU,GAAG,KAAK9D,aAAL,CAAmB+D,IAAnB,EAAnB;;AACA,QAAID,UAAJ,EAAgB;AACd,WAAK1D,IAAL,CAAUQ,GAAV,CAAc,2DAAd;AACA,WAAKR,IAAL,CAAUuB,QAAV,CAAmB;AACjBT,QAAAA,cAAc,EAAE4C,UAAU,CAAC5C,cAAX,IAA6B,EAD5B;AAEjBa,QAAAA,KAAK,EAAE+B,UAAU,CAAC/B,KAAX,IAAoB,EAFV;AAGjBH,QAAAA,cAAc,EAAEkC;AAHC,OAAnB;AAKA,WAAKE,eAAL,GAAuBF,UAAU,CAACG,UAAlC;AACD;AACF;AAED;AACF;AACA;AACA;;;AACEC,EAAAA,eAAe,GAAI;AACjB,UAAMC,YAAY,GAAG,EAArB;AAEA,SAAK/D,IAAL,CAAUqC,QAAV,GAAqBnB,OAArB,CAA8Bf,IAAD,IAAU;AACrC,UAAI,CAACA,IAAI,CAAC6D,QAAN,IAAkB,CAAC7D,IAAI,CAAC6D,QAAL,CAAcC,aAArC,EAAoD;AAClDF,QAAAA,YAAY,CAAC5D,IAAI,CAACQ,EAAN,CAAZ,GAAwBR,IAAxB;AACD;AACF,KAJD;AAMA,WAAO4D,YAAP;AACD;AAED;AACF;AACA;AACA;AACA;;;AACEG,EAAAA,iBAAiB,GAAI;AACnB,UAAMC,cAAc,GAAG,EAAvB;AAEA,UAAM;AAAErD,MAAAA;AAAF,QAAqB,KAAKd,IAAL,CAAUe,QAAV,EAA3B;;AACA,QAAID,cAAJ,EAAoB;AAClB,YAAMsD,SAAS,GAAGpD,MAAM,CAACC,IAAP,CAAYH,cAAZ,CAAlB;AACAsD,MAAAA,SAAS,CAAClD,OAAV,CAAmBmD,QAAD,IAAc;AAC9B,cAAMC,aAAa,GAAGxD,cAAc,CAACuD,QAAD,CAAd,CAAyB3C,OAA/C;AACA4C,QAAAA,aAAa,CAACpD,OAAd,CAAuBqD,MAAD,IAAY;AAChCJ,UAAAA,cAAc,CAACI,MAAD,CAAd,GAAyB,KAAKvE,IAAL,CAAUwE,OAAV,CAAkBD,MAAlB,CAAzB;AACD,SAFD;AAGD,OALD;AAMD;;AAED,WAAOJ,cAAP;AACD;;AAEDd,EAAAA,4BAA4B,GAAI;AAC9B,UAAMoB,WAAW,GAAG,EAClB,GAAG,KAAKX,eAAL,EADe;AAElB,SAAG,KAAKI,iBAAL;AAFe,KAApB,CAD8B,CAM9B;;AACA,QAAIlD,MAAM,CAACC,IAAP,CAAYwD,WAAZ,EAAyB3C,MAAzB,KAAoC,CAAxC,EAA2C;AACzC,WAAK9B,IAAL,CAAUuB,QAAV,CAAmB;AAAEC,QAAAA,cAAc,EAAE;AAAlB,OAAnB;AACA5B,MAAAA,aAAa,CAACoC,OAAd,CAAsB,KAAKhC,IAAL,CAAUC,IAAV,CAAeU,EAArC;AACA;AACD,KAX6B,CAa9B;AACA;AACA;;;AACA,UAAM+D,sBAAsB,GAAG,EAA/B;AACA1D,IAAAA,MAAM,CAACC,IAAP,CAAYwD,WAAZ,EAAyBvD,OAAzB,CAAkCf,IAAD,IAAU;AACzC,UAAIsE,WAAW,CAACtE,IAAD,CAAX,CAAkBC,QAAtB,EAAgC;AAC9BsE,QAAAA,sBAAsB,CAACvE,IAAD,CAAtB,GAA+B,EAC7B,GAAGsE,WAAW,CAACtE,IAAD,CADe;AAE7BwE,UAAAA,UAAU,EAAE;AAFiB,SAA/B;AAID,OALD,MAKO;AACLD,QAAAA,sBAAsB,CAACvE,IAAD,CAAtB,GAA+B,EAC7B,GAAGsE,WAAW,CAACtE,IAAD,CADe;AAE7BwE,UAAAA,UAAU,EAAE,IAFiB;AAG7BC,UAAAA,IAAI,EAAE,IAHuB;AAI7BC,UAAAA,OAAO,EAAE;AAJoB,SAA/B;AAMD;AACF,KAdD;AAgBA,UAAMhB,UAAU,GAAG,EAAnB,CAjC8B,CAkC9B;AACA;AACA;;AACA,SAAK7D,IAAL,CAAU8E,IAAV,CAAe,kBAAf,EAAoCF,IAAD,IAAU;AAC3C5D,MAAAA,MAAM,CAAC+D,MAAP,CAAclB,UAAd,EAA0Be,IAA1B;AACD,KAFD;AAIA,UAAM;AAAE9D,MAAAA;AAAF,QAAqB,KAAKd,IAAL,CAAUe,QAAV,EAA3B;AAEA,SAAKnB,aAAL,CAAmBoF,IAAnB,CAAwB;AACtBlE,MAAAA,cADsB;AAEtBa,MAAAA,KAAK,EAAE+C,sBAFe;AAGtBb,MAAAA;AAHsB,KAAxB;AAKD;;AAEDrB,EAAAA,8BAA8B,GAAI;AAChC,QAAI,CAAC,KAAK9C,kBAAV,EAA8B;AAC5B,aAAO4C,OAAO,CAAC2C,OAAR,CAAgB,EAAhB,CAAP;AACD;;AAED,WAAO,KAAKvF,kBAAL,CAAwBwF,IAAxB,GAA+BrD,IAA/B,CAAqCc,KAAD,IAAW;AACpD,YAAMhB,KAAK,GAAG,KAAK3B,IAAL,CAAUqC,QAAV,EAAd;AACA,YAAM8C,cAAc,GAAGxD,KAAK,CAACyD,MAAN,CAAcjF,IAAD,IAAU;AAC5C;AACA,eAAO,CAACA,IAAI,CAACC,QAAb;AACD,OAHsB,CAAvB;AAKA,YAAMiF,sBAAsB,GAAGrE,MAAM,CAACC,IAAP,CAAY0B,KAAZ,EAAmBb,MAAlD;AACA,YAAMwD,4BAA4B,GAAGH,cAAc,CAACrD,MAApD;;AAEA,UAAIuD,sBAAsB,KAAKC,4BAA/B,EAA6D;AAC3D,aAAKtF,IAAL,CAAUQ,GAAV,CAAe,4CAA2C6E,sBAAuB,6BAAjF;AACA,eAAO1C,KAAP;AACD;;AACD,WAAK3C,IAAL,CAAUQ,GAAV,CAAc,6EAAd;AACA,aAAO,EAAP;AACD,KAhBM,EAgBJF,KAhBI,CAgBGC,GAAD,IAAS;AAChB,WAAKP,IAAL,CAAUQ,GAAV,CAAc,+DAAd,EAA+E,SAA/E;AACA,WAAKR,IAAL,CAAUQ,GAAV,CAAcD,GAAd;AACA,aAAO,EAAP;AACD,KApBM,CAAP;AAqBD;;AAEDkC,EAAAA,0BAA0B,GAAI;AAC5B,WAAO,KAAK9C,cAAL,CAAoBuF,IAApB,GAA2BrD,IAA3B,CAAiCc,KAAD,IAAW;AAChD,YAAM0C,sBAAsB,GAAGrE,MAAM,CAACC,IAAP,CAAY0B,KAAZ,EAAmBb,MAAlD;;AAEA,UAAIuD,sBAAsB,GAAG,CAA7B,EAAgC;AAC9B,aAAKrF,IAAL,CAAUQ,GAAV,CAAe,4CAA2C6E,sBAAuB,wBAAjF;AACA,eAAO1C,KAAP;AACD;;AACD,WAAK3C,IAAL,CAAUQ,GAAV,CAAc,+CAAd;AACA,aAAO,EAAP;AACD,KATM,EASJF,KATI,CASGC,GAAD,IAAS;AAChB,WAAKP,IAAL,CAAUQ,GAAV,CAAc,0DAAd,EAA0E,SAA1E;AACA,WAAKR,IAAL,CAAUQ,GAAV,CAAcD,GAAd;AACA,aAAO,EAAP;AACD,KAbM,CAAP;AAcD;;AAEDqC,EAAAA,aAAa,CAAED,KAAF,EAAS;AACpB,UAAM4C,aAAa,GAAG,EAAtB;AACA,UAAMC,YAAY,GAAG,EAAE,GAAG,KAAKxF,IAAL,CAAUe,QAAV,GAAqBY;AAA1B,KAArB,CAFoB,CAIpB;;AACAX,IAAAA,MAAM,CAACC,IAAP,CAAY0B,KAAZ,EAAmBzB,OAAnB,CAA4BqD,MAAD,IAAY;AACrC,YAAMkB,YAAY,GAAG,KAAKzF,IAAL,CAAUwE,OAAV,CAAkBD,MAAlB,CAArB;;AACA,UAAI,CAACkB,YAAL,EAAmB;AACjBF,QAAAA,aAAa,CAACG,IAAd,CAAmBnB,MAAnB;AACA;AACD;;AAED,YAAMoB,UAAU,GAAGhD,KAAK,CAAC4B,MAAD,CAAxB;AAEA,YAAMqB,eAAe,GAAG;AACtBhB,QAAAA,IAAI,EAAEe,UADgB;AAEtBhB,QAAAA,UAAU,EAAE,IAFU;AAGtBkB,QAAAA,OAAO,EAAE;AAHa,OAAxB;AAKAL,MAAAA,YAAY,CAACjB,MAAD,CAAZ,GAAuB,EAAE,GAAGkB,YAAL;AAAmB,WAAGG;AAAtB,OAAvB;AACD,KAfD,EALoB,CAsBpB;AACA;;AACA5E,IAAAA,MAAM,CAACC,IAAP,CAAYuE,YAAZ,EAA0BtE,OAA1B,CAAmCqD,MAAD,IAAY;AAC5C,UAAIiB,YAAY,CAACjB,MAAD,CAAZ,CAAqBK,IAArB,KAA8B,IAAlC,EAAwC;AACtCY,QAAAA,YAAY,CAACjB,MAAD,CAAZ,GAAuB,EACrB,GAAGiB,YAAY,CAACjB,MAAD,CADM;AAErBsB,UAAAA,OAAO,EAAE;AAFY,SAAvB;AAID;AACF,KAPD;AASA,SAAK7F,IAAL,CAAUuB,QAAV,CAAmB;AACjBI,MAAAA,KAAK,EAAE6D;AADU,KAAnB;AAIA,SAAKxF,IAAL,CAAU8E,IAAV,CAAe,UAAf,EAA2B,KAAKlB,eAAhC;;AAEA,QAAI2B,aAAa,CAACzD,MAAlB,EAA0B;AACxB,WAAKF,WAAL,CAAiB2D,aAAjB,EAAgC1D,IAAhC,CAAqC,MAAM;AACzC,aAAK7B,IAAL,CAAUQ,GAAV,CAAe,gCAA+B+E,aAAa,CAACzD,MAAO,YAAnE;AACD,OAFD,EAEGxB,KAFH,CAEUC,GAAD,IAAS;AAChB,aAAKP,IAAL,CAAUQ,GAAV,CAAe,wCAAuC+E,aAAa,CAACzD,MAAO,YAA3E,EAAwF,SAAxF;AACA,aAAK9B,IAAL,CAAUQ,GAAV,CAAcD,GAAd;AACD,OALD;AAMD;AACF;;AAEDqB,EAAAA,WAAW,CAAEF,OAAF,EAAW;AACpB,UAAMoE,QAAQ,GAAG,EAAjB;AACApE,IAAAA,OAAO,CAACR,OAAR,CAAiBP,EAAD,IAAQ;AACtB,UAAI,KAAKjB,kBAAT,EAA6B;AAC3BoG,QAAAA,QAAQ,CAACJ,IAAT,CAAc,KAAKhG,kBAAL,CAAwBgB,MAAxB,CAA+BC,EAA/B,CAAd;AACD;;AACD,UAAI,KAAKhB,cAAT,EAAyB;AACvBmG,QAAAA,QAAQ,CAACJ,IAAT,CAAc,KAAK/F,cAAL,CAAoBe,MAApB,CAA2BC,EAA3B,CAAd;AACD;AACF,KAPD;AAQA,WAAO2B,OAAO,CAACC,GAAR,CAAYuD,QAAZ,CAAP;AACD;;AA8FDC,EAAAA,OAAO,GAAI;AACT,SAAKtC,YAAL;AACA,SAAKrB,YAAL;AAEA,SAAKpC,IAAL,CAAUgG,EAAV,CAAa,YAAb,EAA2B,KAAK9F,eAAhC;AACA,SAAKF,IAAL,CAAUgG,EAAV,CAAa,sBAAb,EAAqC,KAAKpF,mBAA1C;AACA,SAAKZ,IAAL,CAAUgG,EAAV,CAAa,cAAb,EAA6B,KAAKvF,oBAAlC;AACA,SAAKT,IAAL,CAAUgG,EAAV,CAAa,cAAb,EAA6B,KAAK3C,4BAAlC;AACA,SAAKrD,IAAL,CAAUgG,EAAV,CAAa,mBAAb,EAAkC,KAAKnF,sBAAvC;AACA,SAAKb,IAAL,CAAUgG,EAAV,CAAa,kBAAb,EAAiC,KAAKvE,YAAtC;AACA,SAAKzB,IAAL,CAAUgG,EAAV,CAAa,UAAb,EAAyB,KAAK/D,cAA9B;AACD;;AAEDgE,EAAAA,SAAS,GAAI;AACX,SAAKjG,IAAL,CAAUkG,GAAV,CAAc,YAAd,EAA4B,KAAKhG,eAAjC;AACA,SAAKF,IAAL,CAAUkG,GAAV,CAAc,sBAAd,EAAsC,KAAKtF,mBAA3C;AACA,SAAKZ,IAAL,CAAUkG,GAAV,CAAc,cAAd,EAA8B,KAAKzF,oBAAnC;AACA,SAAKT,IAAL,CAAUkG,GAAV,CAAc,cAAd,EAA8B,KAAK7C,4BAAnC;AACA,SAAKrD,IAAL,CAAUkG,GAAV,CAAc,mBAAd,EAAmC,KAAKrF,sBAAxC;AACA,SAAKb,IAAL,CAAUkG,GAAV,CAAc,kBAAd,EAAkC,KAAKzE,YAAvC;AACA,SAAKzB,IAAL,CAAUkG,GAAV,CAAc,UAAd,EAA0B,KAAKjE,cAA/B;AACD;;AA1WqD;;AAAnCnC,e,CACZqG,O,GAAUtG,WAAW,CAACuG,O;iBADVtG,e","sourcesContent":["import throttle from 'lodash.throttle'\nimport BasePlugin from '@uppy/core/lib/BasePlugin'\nimport ServiceWorkerStore from './ServiceWorkerStore.js'\nimport IndexedDBStore from './IndexedDBStore.js'\nimport MetaDataStore from './MetaDataStore.js'\n\nimport packageJson from '../package.json'\n\n/**\n * The GoldenRetriever plugin — restores selected files and resumes uploads\n * after a closed tab or a browser crash!\n *\n * Uses localStorage, IndexedDB and ServiceWorker to do its magic, read more:\n * https://uppy.io/blog/2017/07/golden-retriever/\n */\nexport default class GoldenRetriever extends BasePlugin {\n  static VERSION = packageJson.version\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'debugger'\n    this.id = this.opts.id || 'GoldenRetriever'\n    this.title = 'Golden Retriever'\n\n    const defaultOptions = {\n      expires: 24 * 60 * 60 * 1000, // 24 hours\n      serviceWorker: false,\n    }\n\n    this.opts = { ...defaultOptions, ...opts }\n\n    this.MetaDataStore = new MetaDataStore({\n      expires: this.opts.expires,\n      storeName: uppy.getID(),\n    })\n    this.ServiceWorkerStore = null\n    if (this.opts.serviceWorker) {\n      this.ServiceWorkerStore = new ServiceWorkerStore({ storeName: uppy.getID() })\n    }\n    this.IndexedDBStore = new IndexedDBStore({\n      expires: this.opts.expires,\n      ...this.opts.indexedDB || {},\n      storeName: uppy.getID(),\n    })\n\n    this.saveFilesStateToLocalStorage = throttle(\n      this.saveFilesStateToLocalStorage.bind(this),\n      500,\n      { leading: true, trailing: true },\n    )\n    this.restoreState = this.restoreState.bind(this)\n    this.loadFileBlobsFromServiceWorker = this.loadFileBlobsFromServiceWorker.bind(this)\n    this.loadFileBlobsFromIndexedDB = this.loadFileBlobsFromIndexedDB.bind(this)\n    this.onBlobsLoaded = this.onBlobsLoaded.bind(this)\n  }\n\n  restoreState () {\n    const savedState = this.MetaDataStore.load()\n    if (savedState) {\n      this.uppy.log('[GoldenRetriever] Recovered some state from Local Storage')\n      this.uppy.setState({\n        currentUploads: savedState.currentUploads || {},\n        files: savedState.files || {},\n        recoveredState: savedState,\n      })\n      this.savedPluginData = savedState.pluginData\n    }\n  }\n\n  /**\n   * Get file objects that are currently waiting: they've been selected,\n   * but aren't yet being uploaded.\n   */\n  getWaitingFiles () {\n    const waitingFiles = {}\n\n    this.uppy.getFiles().forEach((file) => {\n      if (!file.progress || !file.progress.uploadStarted) {\n        waitingFiles[file.id] = file\n      }\n    })\n\n    return waitingFiles\n  }\n\n  /**\n   * Get file objects that are currently being uploaded. If a file has finished\n   * uploading, but the other files in the same batch have not, the finished\n   * file is also returned.\n   */\n  getUploadingFiles () {\n    const uploadingFiles = {}\n\n    const { currentUploads } = this.uppy.getState()\n    if (currentUploads) {\n      const uploadIDs = Object.keys(currentUploads)\n      uploadIDs.forEach((uploadID) => {\n        const filesInUpload = currentUploads[uploadID].fileIDs\n        filesInUpload.forEach((fileID) => {\n          uploadingFiles[fileID] = this.uppy.getFile(fileID)\n        })\n      })\n    }\n\n    return uploadingFiles\n  }\n\n  saveFilesStateToLocalStorage () {\n    const filesToSave = {\n      ...this.getWaitingFiles(),\n      ...this.getUploadingFiles(),\n    }\n\n    // If all files have been removed by the user, clear recovery state\n    if (Object.keys(filesToSave).length === 0) {\n      this.uppy.setState({ recoveredState: null })\n      MetaDataStore.cleanup(this.uppy.opts.id)\n      return\n    }\n\n    // We dont’t need to store file.data on local files, because the actual blob will be restored later,\n    // and we want to avoid having weird properties in the serialized object.\n    // Also adding file.isRestored to all files, since they will be restored from local storage\n    const filesToSaveWithoutData = {}\n    Object.keys(filesToSave).forEach((file) => {\n      if (filesToSave[file].isRemote) {\n        filesToSaveWithoutData[file] = {\n          ...filesToSave[file],\n          isRestored: true,\n        }\n      } else {\n        filesToSaveWithoutData[file] = {\n          ...filesToSave[file],\n          isRestored: true,\n          data: null,\n          preview: null,\n        }\n      }\n    })\n\n    const pluginData = {}\n    // TODO Find a better way to do this?\n    // Other plugins can attach a restore:get-data listener that receives this callback.\n    // Plugins can then use this callback (sync) to provide data to be stored.\n    this.uppy.emit('restore:get-data', (data) => {\n      Object.assign(pluginData, data)\n    })\n\n    const { currentUploads } = this.uppy.getState()\n\n    this.MetaDataStore.save({\n      currentUploads,\n      files: filesToSaveWithoutData,\n      pluginData,\n    })\n  }\n\n  loadFileBlobsFromServiceWorker () {\n    if (!this.ServiceWorkerStore) {\n      return Promise.resolve({})\n    }\n\n    return this.ServiceWorkerStore.list().then((blobs) => {\n      const files = this.uppy.getFiles()\n      const localFilesOnly = files.filter((file) => {\n        // maybe && !file.progress.uploadComplete\n        return !file.isRemote\n      })\n\n      const numberOfFilesRecovered = Object.keys(blobs).length\n      const numberOfFilesTryingToRecover = localFilesOnly.length\n\n      if (numberOfFilesRecovered === numberOfFilesTryingToRecover) {\n        this.uppy.log(`[GoldenRetriever] Successfully recovered ${numberOfFilesRecovered} blobs from Service Worker!`)\n        return blobs\n      }\n      this.uppy.log('[GoldenRetriever] No blobs found in Service Worker, trying IndexedDB now...')\n      return {}\n    }).catch((err) => {\n      this.uppy.log('[GoldenRetriever] Failed to recover blobs from Service Worker', 'warning')\n      this.uppy.log(err)\n      return {}\n    })\n  }\n\n  loadFileBlobsFromIndexedDB () {\n    return this.IndexedDBStore.list().then((blobs) => {\n      const numberOfFilesRecovered = Object.keys(blobs).length\n\n      if (numberOfFilesRecovered > 0) {\n        this.uppy.log(`[GoldenRetriever] Successfully recovered ${numberOfFilesRecovered} blobs from IndexedDB!`)\n        return blobs\n      }\n      this.uppy.log('[GoldenRetriever] No blobs found in IndexedDB')\n      return {}\n    }).catch((err) => {\n      this.uppy.log('[GoldenRetriever] Failed to recover blobs from IndexedDB', 'warning')\n      this.uppy.log(err)\n      return {}\n    })\n  }\n\n  onBlobsLoaded (blobs) {\n    const obsoleteBlobs = []\n    const updatedFiles = { ...this.uppy.getState().files }\n\n    // Loop through blobs that we can restore, add blobs to file objects\n    Object.keys(blobs).forEach((fileID) => {\n      const originalFile = this.uppy.getFile(fileID)\n      if (!originalFile) {\n        obsoleteBlobs.push(fileID)\n        return\n      }\n\n      const cachedData = blobs[fileID]\n\n      const updatedFileData = {\n        data: cachedData,\n        isRestored: true,\n        isGhost: false,\n      }\n      updatedFiles[fileID] = { ...originalFile, ...updatedFileData }\n    })\n\n    // Loop through files that we can’t restore fully — we only have meta, not blobs,\n    // set .isGhost on them, also set isRestored to all files\n    Object.keys(updatedFiles).forEach((fileID) => {\n      if (updatedFiles[fileID].data === null) {\n        updatedFiles[fileID] = {\n          ...updatedFiles[fileID],\n          isGhost: true,\n        }\n      }\n    })\n\n    this.uppy.setState({\n      files: updatedFiles,\n    })\n\n    this.uppy.emit('restored', this.savedPluginData)\n\n    if (obsoleteBlobs.length) {\n      this.deleteBlobs(obsoleteBlobs).then(() => {\n        this.uppy.log(`[GoldenRetriever] Cleaned up ${obsoleteBlobs.length} old files`)\n      }).catch((err) => {\n        this.uppy.log(`[GoldenRetriever] Could not clean up ${obsoleteBlobs.length} old files`, 'warning')\n        this.uppy.log(err)\n      })\n    }\n  }\n\n  deleteBlobs (fileIDs) {\n    const promises = []\n    fileIDs.forEach((id) => {\n      if (this.ServiceWorkerStore) {\n        promises.push(this.ServiceWorkerStore.delete(id))\n      }\n      if (this.IndexedDBStore) {\n        promises.push(this.IndexedDBStore.delete(id))\n      }\n    })\n    return Promise.all(promises)\n  }\n\n  addBlobToStores = (file) => {\n    if (file.isRemote) return\n\n    if (this.ServiceWorkerStore) {\n      this.ServiceWorkerStore.put(file).catch((err) => {\n        this.uppy.log('[GoldenRetriever] Could not store file', 'warning')\n        this.uppy.log(err)\n      })\n    }\n\n    this.IndexedDBStore.put(file).catch((err) => {\n      this.uppy.log('[GoldenRetriever] Could not store file', 'warning')\n      this.uppy.log(err)\n    })\n  }\n\n  removeBlobFromStores = (file) => {\n    if (this.ServiceWorkerStore) {\n      this.ServiceWorkerStore.delete(file.id).catch((err) => {\n        this.uppy.log('[GoldenRetriever] Failed to remove file', 'warning')\n        this.uppy.log(err)\n      })\n    }\n    this.IndexedDBStore.delete(file.id).catch((err) => {\n      this.uppy.log('[GoldenRetriever] Failed to remove file', 'warning')\n      this.uppy.log(err)\n    })\n  }\n\n  replaceBlobInStores = (file) => {\n    this.removeBlobFromStores(file)\n    this.addBlobToStores(file)\n  }\n\n  handleRestoreConfirmed = () => {\n    this.uppy.log('[GoldenRetriever] Restore confirmed, proceeding...')\n    // start all uploads again when file blobs are restored\n    const { currentUploads } = this.uppy.getState()\n    if (currentUploads) {\n      Object.keys(currentUploads).forEach((uploadId) => {\n        this.uppy.restore(uploadId, currentUploads[uploadId])\n      })\n      this.uppy.resumeAll()\n    }\n    this.uppy.upload()\n    this.uppy.setState({ recoveredState: null })\n  }\n\n  abortRestore = () => {\n    this.uppy.log('[GoldenRetriever] Aborting restore...')\n\n    const fileIDs = Object.keys(this.uppy.getState().files)\n    this.deleteBlobs(fileIDs).then(() => {\n      this.uppy.log(`[GoldenRetriever] Removed ${fileIDs.length} files`)\n    }).catch((err) => {\n      this.uppy.log(`[GoldenRetriever] Could not remove ${fileIDs.length} files`, 'warning')\n      this.uppy.log(err)\n    })\n\n    this.uppy.cancelAll()\n    this.uppy.setState({ recoveredState: null })\n    MetaDataStore.cleanup(this.uppy.opts.id)\n  }\n\n  handleComplete = ({ successful }) => {\n    const fileIDs = successful.map((file) => file.id)\n    this.deleteBlobs(fileIDs).then(() => {\n      this.uppy.log(`[GoldenRetriever] Removed ${successful.length} files that finished uploading`)\n    }).catch((err) => {\n      this.uppy.log(`[GoldenRetriever] Could not remove ${successful.length} files that finished uploading`, 'warning')\n      this.uppy.log(err)\n    })\n\n    this.uppy.setState({ recoveredState: null })\n    MetaDataStore.cleanup(this.uppy.opts.id)\n  }\n\n  restoreBlobs = () => {\n    if (this.uppy.getFiles().length > 0) {\n      Promise.all([\n        this.loadFileBlobsFromServiceWorker(),\n        this.loadFileBlobsFromIndexedDB(),\n      ]).then((resultingArrayOfObjects) => {\n        const blobs = { ...resultingArrayOfObjects[0], ...resultingArrayOfObjects[1] }\n        this.onBlobsLoaded(blobs)\n      })\n    } else {\n      this.uppy.log('[GoldenRetriever] No files need to be loaded, only restoring processing state...')\n      this.onBlobsLoaded([])\n    }\n  }\n\n  install () {\n    this.restoreState()\n    this.restoreBlobs()\n\n    this.uppy.on('file-added', this.addBlobToStores)\n    this.uppy.on('file-editor:complete', this.replaceBlobInStores)\n    this.uppy.on('file-removed', this.removeBlobFromStores)\n    this.uppy.on('state-update', this.saveFilesStateToLocalStorage)\n    this.uppy.on('restore-confirmed', this.handleRestoreConfirmed)\n    this.uppy.on('restore-canceled', this.abortRestore)\n    this.uppy.on('complete', this.handleComplete)\n  }\n\n  uninstall () {\n    this.uppy.off('file-added', this.addBlobToStores)\n    this.uppy.off('file-editor:complete', this.replaceBlobInStores)\n    this.uppy.off('file-removed', this.removeBlobFromStores)\n    this.uppy.off('state-update', this.saveFilesStateToLocalStorage)\n    this.uppy.off('restore-confirmed', this.handleRestoreConfirmed)\n    this.uppy.off('restore-canceled', this.abortRestore)\n    this.uppy.off('complete', this.handleComplete)\n  }\n}\n"]}